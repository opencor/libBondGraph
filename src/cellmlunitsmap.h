#ifndef CELLMLUNITSMAP_H__
#define CELLMLUNITSMAP_H__
#include "Exceptions.h"
#include "thirdparty/tinyxml2.h"
#include <algorithm>
#include <cctype>
#include <map>
#include <sstream>
#include <string>
#include <units.hpp>
#include <unordered_map>
#include <vector>
#include <tuple>

namespace BG {

class CellMLUnits
{
private:
    std::unordered_map<std::string, units::precise_unit> dimensions;
    std::unordered_map<std::string, std::string> existingNames;
    std::string predinedunitsXML;

public:
    inline std::string trim(const std::string &s)
    {
        auto wsfront = std::find_if_not(s.begin(), s.end(), [](int c) { return std::isspace(c); });
        auto wsback = std::find_if_not(s.rbegin(), s.rend(), [](int c) { return std::isspace(c); }).base();
        return (wsback <= wsfront ? std::string() : std::string(wsfront, wsback));
    }

    CellMLUnits()
    {
        std::string predinedunitsXMLinHex = "3c3f786d6c2076657273696f6e3d27312e302720656e636f64696e673d275554462d38273f3e0a3c6d6f64656c206e616d653d22556e6974732220786d6c6e733d22687474703a2f2f7777772e63656c6c6d6c2e6f72672f63656c6c6d6c2f312e31232220786d6c6e733a63656c6c6d6c3d22687474703a2f2f7777772e63656c6c6d6c2e6f72672f63656c6c6d6c2f312e3123223e0a202020203c756e697473206e616d653d227332223e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20646973706c6163656d656e742d2d3e0a202020203c756e697473206e616d653d226d6d223e0a20202020202020203c756e6974207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20617265612d2d3e0a202020203c756e697473206e616d653d226d32223e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6d32223e0a20202020202020203c756e6974206578706f6e656e743d223222207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20766f6c756d652d2d3e0a202020203c756e697473206e616d653d226d33223e0a20202020202020203c756e6974206578706f6e656e743d22332220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6d33223e0a20202020202020203c756e6974206578706f6e656e743d223322207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a20706f7765722d2d3e0a202020203c756e697473206e616d653d224a5f7065725f73223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a20666c6f7720286d6f6c6172292d2d3e0a202020203c756e697473206e616d653d226d6f6c5f7065725f73223e0a20202020202020203c756e697420756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6d6f6c5f7065725f73223e0a20202020202020203c756e6974207072656669783d226d696c6c692220756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d22756d6f6c5f7065725f73223e0a20202020202020203c756e6974207072656669783d226d6963726f2220756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20666c6f77202863757272656e74292d2d3e0a202020203c756e697473206e616d653d22435f7065725f73223e0a20202020202020203c756e697420756e6974733d22636f756c6f6d62222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d435f7065725f73223e0a20202020202020203c756e6974207072656669783d226d696c6c692220756e6974733d22636f756c6f6d62222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d2275435f7065725f73223e0a20202020202020203c756e6974207072656669783d226d6963726f2220756e6974733d22636f756c6f6d62222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226e435f7065725f73223e0a20202020202020203c756e6974207072656669783d226e616e6f2220756e6974733d22636f756c6f6d62222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20666c6f77202876656c6f63697479292d2d3e0a202020203c756e697473206e616d653d226d5f7065725f73223e0a20202020202020203c756e697420756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6d5f7065725f73223e0a20202020202020203c756e6974207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d22756d5f7065725f73223e0a20202020202020203c756e6974207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d227261645f7065725f73223e0a20202020202020203c756e697420756e6974733d2272616469616e222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20666c6f772028766f6c756d6574726963292d2d3e0a202020203c756e697473206e616d653d226d335f7065725f73223e0a20202020202020203c756e6974206578706f6e656e743d22332220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d22735f7065725f6d33223e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6d335f7065725f73223e0a20202020202020203c756e6974206578706f6e656e743d223322207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226c5f7065725f73223e0a20202020202020203c756e697420756e6974733d226c69747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a20706f74656e7469616c20286368656d6963616c292d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d6f6c223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d6f6c65222f3e0a202020203c2f756e6974733e0a202020203c212d2d20706f74656e7469616c2028766f6c74616765292d2d3e0a202020203c756e697473206e616d653d224a5f7065725f43223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d22636f756c6f6d62222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a5f7065725f435f73223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d22636f756c6f6d62222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20706f74656e7469616c2028666f726365292d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20706f74656e7469616c20287072657373757265292d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d33223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a5f7065725f6c223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a5f7065725f6d335f73223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a20696e64756374616e63652d2d3e0a202020203c756e697473206e616d653d224a73325f7065725f6d6f6c32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d6f6c65222f3e0a202020203c2f756e6974733e0a202020203c212d2d20656c617374616e63652d2d3e0a202020203c756e697473206e616d653d224a735f7065725f6d6f6c32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d6f6c65222f3e0a202020203c2f756e6974733e0a202020203c212d2d20726573697374616e63652d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d6f6c32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d6f6c65222f3e0a202020203c2f756e6974733e0a202020203c212d2d20636f6e64756374616e63652d2d3e0a202020203c756e697473206e616d653d2243325f7065725f4a5f73223e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d22636f756c6f6d62222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d2063617061636974616e63652d2d3e0a202020203c756e697473206e616d653d224a5f7065725f4332223e0a20202020202020203c756e6974206578706f6e656e743d22312220756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d22636f756c6f6d62222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d2243325f7065725f4a223e0a20202020202020203c756e6974206578706f6e656e743d22312220756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d22636f756c6f6d62222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a20636f6e63656e74726174696f6e20286d6f6c6172292d2d3e0a202020203c756e697473206e616d653d226d6f6c5f7065725f6d33223e0a20202020202020203c756e697420756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20636f6e63656e74726174696f6e20284d292d2d3e0a202020203c756e697473206e616d653d224d223e0a20202020202020203c756e697420756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20636f6e63656e74726174696f6e20286d4d292d2d3e0a202020203c756e697473206e616d653d226d4d223e0a20202020202020203c756e6974207072656669783d226d696c6c692220756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20636f6e63656e74726174696f6e2028754d292d2d3e0a202020203c756e697473206e616d653d22754d223e0a20202020202020203c756e6974207072656669783d226d6963726f2220756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20636f6e63656e74726174696f6e20286d617373292d2d3e0a202020203c756e697473206e616d653d226b675f7065725f6d33223e0a20202020202020203c756e697420756e6974733d226b696c6f6772616d222f3e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20636f6e63656e74726174696f6e20286e756d626572292d2d3e0a202020203c756e697473206e616d653d227065725f6d33223e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a20666c75782028646966667573696f6e292d2d3e0a202020203c756e697473206e616d653d226d6f6c5f7065725f6d325f73223e0a20202020202020203c756e697420756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20666c757820284d292d2d3e0a202020203c756e697473206e616d653d226d4d5f6d5f7065725f73223e0a20202020202020203c756e697420756e6974733d226d4d222f3e0a20202020202020203c756e697420756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20666c75782028656e65726779292d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d325f73223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d20666c757820286d617373292d2d3e0a202020203c756e697473206e616d653d224a735f7065725f6d34223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d342220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a207265616374696f6e207261746520286f7264657230292d2d3e0a202020203c756e697473206e616d653d226d4d5f7065725f73223e0a20202020202020203c756e697420756e6974733d226d4d222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d207265616374696f6e207261746520286f7264657231292d2d3e0a202020203c756e697473206e616d653d227065725f73223e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d207265616374696f6e207261746520286f7264657232292d2d3e0a202020203c756e697473206e616d653d227065725f6d4d5f73223e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d4d222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d207265616374696f6e207261746520286f7264657233292d2d3e0a202020203c756e697473206e616d653d226d365f7065725f6d6f6c325f73223e0a20202020202020203c756e6974206578706f6e656e743d22362220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d335f7065725f6d6f6c223e0a20202020202020203c756e6974206578706f6e656e743d22332220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d6f6c65222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6f6c5f7065725f6d335f73223e0a20202020202020203c756e6974206578706f6e656e743d22312220756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a207261746520636f6e7374616e742d2d3e0a202020203c756e697473206e616d653d227065725f6d6f6c223e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d6f6c65222f3e0a202020203c2f756e6974733e0a202020203c212d2d2067617320636f6e7374616e742d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d6f6c5f4b223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d6f6c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226b656c76696e222f3e0a202020203c2f756e6974733e0a202020203c212d2d206661726164617920636f6e7374616e742d2d3e0a202020203c756e697473206e616d653d22435f7065725f6d6f6c223e0a20202020202020203c756e697420756e6974733d22636f756c6f6d62222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d6f6c65222f3e0a202020203c2f756e6974733e0a202020203c212d2d20646966667573697669747920286d617373292d2d3e0a202020203c756e697473206e616d653d226d325f7065725f73223e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d227065725f43223e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d22636f756c6f6d62222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d227065725f6d223e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d227065725f6d4d223e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226d4d222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f204d656368616e6963616c2053797374656d202f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a20696e64756374616e63652d2d3e0a202020203c756e697473206e616d653d224a73325f7065725f6d32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20656c617374616e63652d2d3e0a202020203c756e697473206e616d653d224a735f7065725f6d32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20726573697374616e63652d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20416363656c65726174696f6e2d2d3e0a202020203c756e697473206e616d653d226d5f7065725f7332223e0a20202020202020203c756e697420756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d227261645f7065725f7332223e0a20202020202020203c756e697420756e6974733d2272616469616e222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c212d2d2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f20466c7569642053797374656d202f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f2f0a2044796e616d696320566973636f73697479202850612e73292d2d3e0a202020203c756e697473206e616d653d224a735f7065725f6d33223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d332220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a735f7065725f6c223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d2044656e7369747920286b672f6d33292d2d3e0a202020203c756e697473206e616d653d224a73325f7065725f6d35223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d352220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20436f6d706c69616e63652d2d3e0a202020203c756e697473206e616d653d224a5f7065725f6d36223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d362220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a5f7065725f6c32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20456c617374616e63652d2d3e0a202020203c756e697473206e616d653d226d365f7065725f4a223e0a20202020202020203c756e6974206578706f6e656e743d22362220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226a6f756c65222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226c325f7065725f4a223e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d226c69747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226a6f756c65222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6d365f7065725f4a223e0a20202020202020203c756e6974206578706f6e656e743d223622207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d226a6f756c65222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a73325f7065725f6d39223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d392220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20526573697374616e63652d2d3e0a202020203c756e697473206e616d653d224a735f7065725f6d36223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d362220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a735f7065725f6c32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e697420756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20496e65727469612d2d3e0a202020203c756e697473206e616d653d224a73325f7065725f6d36223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d362220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d224a73325f7065725f6c32223e0a20202020202020203c756e697420756e6974733d226a6f756c65222f3e0a20202020202020203c756e6974206578706f6e656e743d22322220756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d226c69747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d20416363656c65726174696f6e2d2d3e0a202020203c756e697473206e616d653d226d335f7065725f7332223e0a20202020202020203c756e6974206578706f6e656e743d22332220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226c5f7065725f7332223e0a20202020202020203c756e697420756e6974733d226c69747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d226d6d335f7065725f7332223e0a20202020202020203c756e6974206578706f6e656e743d223322207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d322220756e6974733d227365636f6e64222f3e0a202020203c2f756e6974733e0a202020203c756e697473206e616d653d227065725f6d6d33223e0a20202020202020203c756e6974206578706f6e656e743d222d3322207072656669783d226d696c6c692220756e6974733d226d65747265222f3e0a202020203c2f756e6974733e0a202020203c212d2d2056616c766520556e69742d2d3e0a202020203c756e697473206e616d653d22556e697456616c7665223e0a20202020202020203c756e697420756e6974733d226c69747265222f3e0a20202020202020203c756e6974206578706f6e656e743d222d312220756e6974733d227365636f6e64222f3e0a20202020202020203c756e6974206578706f6e656e743d222d302e352220756e6974733d224a5f7065725f6c222f3e0a202020203c2f756e6974733e0a3c2f6d6f64656c3e0a";
        hex2ascii(predinedunitsXMLinHex, predinedunitsXML);
        tinyxml2::XMLDocument doc;
        tinyxml2::XMLPrinter printer;
        std::ostringstream ss;
        if (doc.Parse(predinedunitsXML.c_str()) == tinyxml2::XML_SUCCESS) {
            tinyxml2::XMLElement *pRootElement = doc.RootElement();
            if (pRootElement != nullptr) {
                //Get 'Units'
                tinyxml2::XMLElement *units = pRootElement->FirstChildElement("units");
                while (units) {
                    std::vector<units::precise_unit> subUnits;
                    std::string unitName = trim(units->Attribute("name"));
                    // Get 'unit' Child
                    tinyxml2::XMLElement *unit = units->FirstChildElement("unit");

                    while (unit) {
                        std::string lunit;
                        std::string expon = "1";
                        std::string prefix = "";
                        for (const tinyxml2::XMLAttribute *attr = unit->FirstAttribute(); attr != 0; attr = attr->Next()) {
                            auto an = trim(attr->Name());
                            auto av = trim(attr->Value());
                            if (an == "units") {
                                //Sometimes units definitions use prior definitions
                                if (dimensions.find(av) != dimensions.end()) {
                                    lunit = units::to_string(dimensions[av]);
                                } else {
                                    lunit = units::to_string(units::unit_from_string(av));
                                }
                            } else if (an == "exponent")
                                expon = av;
                            else if (an == "prefix")
                                prefix = av;
                        }
                        ss.str("");
                        ss.clear();

                        if (expon != "1") {
                            ss << "(" << prefix << " " << lunit << ")^" << expon;
                        } else {
                            ss << prefix << " " << lunit;
                        }
                        subUnits.push_back(units::unit_from_string(ss.str()));
                        unit = unit->NextSiblingElement("unit");
                    }

                    units::precise_unit unitDef = subUnits[0];
                    for (int ix = 1; ix < subUnits.size(); ix++) {
                        unitDef = unitDef * subUnits[ix];
                    }
                    auto mult = unitDef.multiplier();
                    auto baseU = unitDef.base_units();
                    auto preciseunit = units::precise_unit(baseU, mult);
                    dimensions[unitName] = preciseunit;
                    //existingNames[preciseunit] = unitName;
                    existingNames[units::to_string(preciseunit)] = unitName;
                    //std::cout<<unitName<<"\t"<<units::to_string(preciseunit)<<std::endl;
                    // Next Units def
                    units = units->NextSiblingElement("units");
                }
            }
        } else {
            throw BGException("Error creating CellML document from resource/Units.cellml");
        }
    };

    unsigned char hexval(unsigned char c)
    {
        if ('0' <= c && c <= '9')
            return c - '0';
        else if ('a' <= c && c <= 'f')
            return c - 'a' + 10;
        else if ('A' <= c && c <= 'F')
            return c - 'A' + 10;
        else
            throw BGException("Error parsing xml (resource/Units.cellml) loaded through cmake");
    };

    void hex2ascii(const std::string &in, std::string &out)
    {
        out.clear();
        out.reserve(in.length() / 2);
        for (std::string::const_iterator p = in.begin(); p != in.end(); p++) {
            unsigned char c = hexval(*p);
            p++;
            if (p == in.end())
                break; // incomplete last digit - should report error
            c = (c << 4) + hexval(*p); // + takes precedence over <<
            out.push_back(c);
        }
    }

    std::string getPredinedunitsXML() {
        return predinedunitsXML;
    }

    std::string
        getUnitName(const std::string &unit)
    {
        //units::precise_unit unit = units::unit_from_string(unitStr);
        if (existingNames.find(unit) != existingNames.end()) {
            return existingNames[unit];
        }
        throw BGException("Name for unit " + unit + " not found");
    }

    std::tuple<std::string,std::string> getCellMLDef(const std::string& unit){
        units::precise_unit unitDef = units::unit_from_string(unit);
        auto mult = unitDef.multiplier();
        auto baseU = unitDef.base_units();
        std::vector<std::string> unitl;
        std::string multiplier = "";
        if(mult!=1.0){
            multiplier = "multiplier=\""+std::to_string(mult)+"\"";
        }
        if(baseU.meter()!=0){
            std::string mx = multiplier;
            if(baseU.meter()<0){
                mx = "";
            }
            if(baseU.meter()!=1){
                unitl.push_back("<unit "+mx+" exponent=\""+std::to_string(baseU.meter())+"\" units=\"metre\" />");
            }else{
                unitl.push_back("<unit "+mx+" units=\"metre\" />");
            }
            if(baseU.meter()>0){
                multiplier = "";
            }            
        }
        if(baseU.kg()!=0){
            std::string mx = multiplier;
            if(baseU.kg()<0){
                mx = "";
            }            
            if(baseU.kg()!=1){
                unitl.push_back("<unit "+mx+" exponent=\""+std::to_string(baseU.kg())+"\" units=\"kilogram\" />");
            }else{
                unitl.push_back("<unit "+mx+" units=\"kilogram\" />");
            }
            if(baseU.kg()>0){
                multiplier = "";
            }             
        }
        if(baseU.second()!=0){
            std::string mx = multiplier;
            if(baseU.second()<0){
                mx = "";
            }            
            if(baseU.second()!=1){
                unitl.push_back("<unit "+mx+" exponent=\""+std::to_string(baseU.second())+"\" units=\"second\" />");
            }else{
                unitl.push_back("<unit "+mx+" units=\"second\" />");
            }
            if(baseU.second()>0){
                multiplier = "";
            }             
        }
        if(baseU.ampere()!=0){
            std::string mx = multiplier;
            if(baseU.ampere()<0){
                mx = "";
            }            
            if(baseU.ampere()!=1){
                unitl.push_back("<unit "+mx+" exponent=\""+std::to_string(baseU.ampere())+"\" units=\"ampere\" />");
            }else{
                unitl.push_back("<unit "+mx+" units=\"ampere\" />");
            }
            if(baseU.ampere()>0){
                multiplier = "";
            }             
        }
        if(baseU.kelvin()!=0){
            std::string mx = multiplier;
            if(baseU.kelvin()<0){
                mx = "";
            }            
            if(baseU.kelvin()!=1){
                unitl.push_back("<unit "+mx+" exponent=\""+std::to_string(baseU.kelvin())+"\" units=\"kelvin\" />");
            }else{
                unitl.push_back("<unit "+mx+" units=\"kelvin\" />");
            }
            if(baseU.kelvin()>0){
                multiplier = "";
            }             
        }
        if(baseU.mole()!=0){
            std::string mx = multiplier;
            if(baseU.mole()<0){
                mx = "";
            }            
            if(baseU.mole()!=1){
                unitl.push_back("<unit "+mx+" exponent=\""+std::to_string(baseU.mole())+"\" units=\"mole\" />");
            }else{
                unitl.push_back("<unit "+mx+" units=\"mole\" />");
            }
            if(baseU.mole()>0){
                multiplier = "";
            }             
        }        
        if(baseU.candela()!=0){
            std::string mx = multiplier;
            if(baseU.candela()<0){
                mx = "";
            }            
            if(baseU.candela()!=1){
                unitl.push_back("<unit "+mx+" exponent=\""+std::to_string(baseU.candela())+"\" units=\"candela\" />");
            }else{
                unitl.push_back("<unit "+mx+" units=\"candela\" />");
            }
            if(baseU.candela()>0){
                multiplier = "";
            }             
        } 
        std::ostringstream ss;
        std::string uname = unit;
        auto replace = [&uname](std::string from, std::string to) {
            size_t start_pos = 0;
            while ((start_pos = uname.find(from, start_pos)) != std::string::npos) {
                uname.replace(start_pos, from.length(), to);
                start_pos += to.length(); // Handles case where 'to' is a substring of 'from'
            }
            return uname;
        };
        replace("/","_");
        replace("*", "_");
        if(isdigit(uname[0])){
            uname = "D"+uname;
        }

        ss<<"<units name=\""<<uname<<"\">"<<std::endl;
        for(auto c: unitl){
            ss<<"\t"<<c<<std::endl;
        }  
        ss<<"</units>"<<std::endl;
        std::string res = ss.str();
        return std::make_tuple(uname,res);
    }
};
} // namespace BG

#endif
